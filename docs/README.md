# Azure Container Registry Login

This action is meant to simplify the process of logging into an Azure Container Registry (ACR) and ensure that best setup is used.

## Input parameters

|Parameter Name|Required?|Type|Default Value|Description|
|---|---|---|---|---|
|client-id|true|UUID||The Client Id of the service principal or managed identity to login as|
|tenant-id|true|UUID||The Tenant Id of the client defined in client-id|
|subscription-id|true|UUID||The Azure Subscription Id of the client defined in client-id & ACR defined in registry-url|
|registry-url|true|URL||The url to the azure container registry (e.g., registry-0123456789abcd.azurecr.io) to log into|
|registry-suffix|true|string||The suffix to the registry that was randomly generated by Azure (e.g., 0123456789abcd)|

## Required setup before use

### Azure login user

This action uses the login with OpenID Connect (OIDC) process for the Azure login and requires the setup of a federated identity credential on a managed identity or a service principal, you can read about how to set that up on the [`azure/login` page](https://github.com/Azure/login/blob/master/README.md#login-with-openid-connect-oidc-recommended)

### Azure login user permissions

The user logging into Azure should have access to the container registry generally this would be `AcrPull` or `AcrPush` you can read more about it [here](https://learn.microsoft.com/en-us/azure/container-registry/container-registry-rbac-built-in-roles-overview?tabs=registries-configured-with-rbac-registry-permissions).


### Workflow permissions

For the Azure login OIDC process to work the workflow job must have `id-token: write` defined at either the job level or workflow level.

> [!NOTE]
> If there were no other permissions defined when adding `id-token: write` you will also need to give `contents: read` as once one permission is defined any undefined permission is inferred permission to be `none`

## Workflow examples

```yaml
# File: .github/workflows/workflow_example.yml

name: Azure Container Registry Login
on: [push]

permissions:
  id-token: write
  contents: read

jobs:
  example:
    runs-on: ubuntu-latest
    steps:
      - name: Registry login
        uses: MicahWW/gh-a-azure-container-registry-login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          registry-url: ${{ vars.ACR_URL }}
          registry-suffix: ${{ vars.ACR_SUFFIX }}

      # run some other actions
```


## Why use access token with docker login

The login process could be shorted by simply removing `docker/login-action` and logging in directly via `az acr login` but this would result in a possible credential/access leak at the end of the calling workflow job as there is no post action step to log out of the docker CLI. This is why the _docker/login-action_ is used, at the end of a workflow job the post action steps from all of the used actions will run and _docker/login-action_ has one to ensure the docker CLI is logged out of.
