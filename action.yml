name: Azure Container Registry Login
description: Log in to Azure Container Registry (ACR) using Azure CLI.
author: MicahWW

inputs:
  client-id:
    description: 'The Client Id of the service principal or managed identity to login as'
    required: true
  tenant-id:
    description: 'The Tenant Id of the client defined in client-id'
    required: true
  subscription-id:
    description: 'The Azure Subscription Id of the client defined in client-id & ACR defined in registry-url'
    required: true
  registry-url:
    description: 'The url to the azure container registry (e.g., registry-0123456789abcd.azurecr.io) to log into'
    required: true
  registry-suffix:
    description: 'The suffix to the registry that was randomly generated by Azure (e.g., 0123456789abcd)'
    required: true

runs:
  using: "composite"
  steps:
    - name: Azure CLI Login
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ inputs.client-id }}
        tenant-id: ${{ inputs.tenant-id }}
        subscription-id: ${{ inputs.subscription-id }}

    # A token to log into the ACR registry is generated using the Azure CLI to be used via the docker command.
    # The generated token is masked in the logs for security and set as an output variable for the later usage.
    # https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-commands#masking-a-value-in-a-log
    - name: Get ACR Access Token
      id: get-acr-token
      shell: bash
      run: |
        accessToken=$(az acr login \
          --name ${{ inputs.registry-url }} \
          --suffix ${{ inputs.registry-suffix }} \
          --expose-token \
          --output tsv \
          --query accessToken
        )
        echo "::add-mask::${accessToken}"
        echo "REGISTRY_ACCESS_TOKEN=${accessToken}" >> $GITHUB_OUTPUT

    # The Docker Login Action is used to log in to the ACR registry using the generated token.
    # The username is set to a fixed value (00000000-0000-0000-0000-000000000000) as required by ACR when using token-based authentication.
    # https://learn.microsoft.com/en-us/azure/container-registry/container-registry-authentication?tabs=azure-cli#use-az-acr-login-without-docker-daemon
    - name: Log in to ACR
      uses: docker/login-action@v3.7.0
      with:
        registry: ${{ inputs.registry-url }}
        username: 00000000-0000-0000-0000-000000000000
        password: ${{ steps.get-acr-token.outputs.REGISTRY_ACCESS_TOKEN }}
